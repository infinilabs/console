pipeline {

    agent none

    environment {
        CI = 'true'
    }
    stages {

       stage('build') {

        parallel {

        stage('Build Docker Images') {

                    agent {
                        label 'linux'
                    }

                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE'){
                            sh 'cd /home/jenkins/go/src/infini.sh/console && git stash && git pull origin master && make clean'

                            sh 'cd /home/jenkins/go/src/infini.sh/console/ && true|| rm -rif web'
                            sh 'cd /home/jenkins/go/src/infini.sh/console/ && true || git clone ssh://git@git.infini.ltd:64221/infini/console-ui.git web'
                            sh 'cd /home/jenkins/go/src/infini.sh/console/web && git pull origin master'
                            sh 'cd /home/jenkins/go/src/infini.sh/console/web && git stash'
                            sh 'cd /home/jenkins/go/src/infini.sh/console/web && cnpm install'
                            sh 'cd /home/jenkins/go/src/infini.sh/console/web && cnpm run build'
                            sh 'cd /home/jenkins/go/src/infini.sh/console && git pull origin master && make config build  && chmod a+x bin/console'

                            sh label: 'copy-configs', script: 'cd /home/jenkins/go/src/infini.sh/console && mkdir -p bin/config && cp config/*.json bin/config  && cp config/*.tpl bin/config'
                            sh label: 'docker-build', script: 'cd /home/jenkins/go/src/infini.sh/console/bin && docker build -t infini-console  -f ../docker/Dockerfile .'
                            sh label: 'docker-tagging', script: 'docker tag infini-console infinilabs/console:latest && docker tag infini-console infinilabs/console:$VERSION-$BUILD_NUMBER'
                            sh label: 'docker-push', script: 'docker push infinilabs/console:$VERSION-$BUILD_NUMBER && docker push infinilabs/console:latest'
                        }
                    }
                }
    } }
    }
}
