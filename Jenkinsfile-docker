pipeline {

    agent none

    environment {
        CI = 'true'
    }
    stages {

       stage('build') {

        parallel {

        stage('Build Docker Images') {

                    agent {
                        label 'linux'
                    }

                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE'){
                            sh 'cd /home/jenkins/go/src/infini.sh/search-center && git stash && git pull origin master && make clean'

                            sh 'cd /home/jenkins/go/src/infini.sh/search-center/ && rm -rif web'
                            sh 'cd /home/jenkins/go/src/infini.sh/search-center/ && git clone ssh://git@git.infini.ltd:64221/infini/console-ui.git web'
                            sh 'cd /home/jenkins/go/src/infini.sh/search-center/web && cnpm install'
                            sh 'cd /home/jenkins/go/src/infini.sh/search-center/web && cnpm run build'
                            sh 'cd /home/jenkins/go/src/infini.sh/search-center/web && mv static/* ../.public/static'

                            sh label: 'docker-build', script: 'cd /home/jenkins/go/src/infini.sh/ && docker build -t infini-console  -f search-center/docker/Dockerfile .'
                            sh label: 'docker-tagging', script: 'docker tag infini-console infinilabs/console:latest && docker tag infini-console infinilabs/console:$VERSION-$BUILD_NUMBER'
                            sh label: 'docker-push', script: 'docker push infinilabs/console:$VERSION-$BUILD_NUMBER && docker push infinilabs/console:latest'
                        }
                    }
                }
    } }
    }
}
